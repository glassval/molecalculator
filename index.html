<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mole Calculator</title>
  <style>
    :root{
      --accent:#2b7a78;
      --accent-2:#6fb3b1;
      --bg:#f6f8f9;
      --card:#ffffff;
      --muted:#6b7280;
      --radius:10px;
      --gap:16px;
    }
    *{box-sizing:border-box}
    body{font-family:Calibri, 'Segoe UI', Roboto, Arial, sans-serif;margin:0;background:linear-gradient(180deg,var(--bg),#eef6f6);color:#0f1724;-webkit-font-smoothing:antialiased}
    .container{max-width:980px;margin:36px auto;background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(15,23,36,0.08);overflow:hidden;border:1px solid rgba(15,23,36,0.04)}
    header{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;padding:26px 22px;text-align:center}
    header h1{margin:0;font-size:30px;font-weight:700;letter-spacing:0.2px}
    .app{display:flex;gap:var(--gap);padding:22px;flex-wrap:wrap;align-items:flex-start}
    .menu{min-width:220px;border-right:1px solid rgba(15,23,36,0.04);padding-right:14px}
    .menu button{display:block;width:100%;margin:8px 0;padding:12px 14px;font-size:15px;border-radius:8px;border:1px solid transparent;background:transparent;color:var(--muted);cursor:pointer;text-align:left;transition:all .18s ease}
    .menu button:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(11,66,64,0.04)}
    .menu button.active{background:linear-gradient(90deg, rgba(43,122,120,0.08), rgba(111,179,177,0.04)); color: #053236; border-color: rgba(11,66,64,0.06); font-weight:600}
    .panel{flex:1;min-width:320px;padding-left:14px}
    .panel section{display:none;padding:8px 6px}
    .panel section.active{display:block}
    .panel h2{margin:6px 0 14px 0;font-size:20px;color:#072f2e}
    .field{display:flex;gap:12px;align-items:center;margin:10px 0}
    .field input[type=text], .field input[type=number]{flex:1;padding:12px 14px;font-size:15px;border:1px solid rgba(15,23,36,0.08);border-radius:8px;background:#fbfdfe}
    .field input[type=number]::-webkit-outer-spin-button, .field input[type=number]::-webkit-inner-spin-button{opacity:0.6}
    .field label{width:150px;color:var(--muted);font-size:14px}
    .btn{padding:10px 16px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-size:15px;cursor:pointer;box-shadow:0 6px 18px rgba(43,122,120,0.12);transition:transform .12s ease}
    .btn:active{transform:translateY(1px)}
    .result{margin-top:12px;padding:14px;border-radius:8px;background:linear-gradient(180deg,#f7fffe,#eef9f8);border:1px solid rgba(11,66,64,0.06);color:#04433f;min-height:44px;font-weight:600;font-size:15px}
    .note{color:var(--muted);font-size:13px;margin-top:8px}
    footer{padding:12px 18px;text-align:center;font-size:13px;color:var(--muted);border-top:1px solid rgba(15,23,36,0.03)}
    @media(max-width:820px){.app{flex-direction:column;padding:14px}.menu{min-width:100%;border-right:none;padding-right:0}.field{flex-direction:column;align-items:stretch}.field label{width:100%}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Mole Calculator</h1>
    </header>
    <div class="app">
      <div class="menu" role="navigation">
        <button data-panel="moles-to-grams" class="active">Moles → Grams</button>
        <button data-panel="grams-to-moles">Grams → Moles</button>
        <button data-panel="moles-to-molecules">Moles → Molecules</button>
        <button data-panel="molecules-to-moles">Molecules → Moles</button>
        <button data-panel="grams-to-molecules">Grams → Molecules</button>
        <button data-panel="molar-mass">Molar Mass</button>
        <button data-panel="molar-mass-gm">Molar Mass (Grams & Molecules)</button>
        <button data-panel="words-to-molecules">Words to Molecule (Ionics)</button>
      </div>
      <div class="panel">
        <section id="moles-to-grams" class="active">
          <h2>Moles → Grams</h2>
          <div class="field"><label>Compound/Element</label><input id="mtg-formula" type="text" placeholder="e.g. H2O or NaCl"></div>
          <div class="field"><label>Moles</label><input id="mtg-moles" type="number" step="any" placeholder="e.g. 0.25"></div>
          <div class="field"><label>Significant figs</label><input id="mtg-sig" type="number" min="1" max="12" value="3"></div>
          <button class="btn" id="mtg-calc">Calculate</button>
          <div class="result" id="mtg-result">Result: —</div>
        </section>

        <section id="grams-to-moles">
          <h2>Grams → Moles</h2>
          <div class="field"><label>Compound/Element</label><input id="gtm-formula" type="text" placeholder="e.g. CO2"></div>
          <div class="field"><label>Grams</label><input id="gtm-grams" type="number" step="any" placeholder="e.g. 12.0"></div>
          <div class="field"><label>Significant figs</label><input id="gtm-sig" type="number" min="1" max="12" value="3"></div>
          <button class="btn" id="gtm-calc">Calculate</button>
          <div class="result" id="gtm-result">Result: —</div>
        </section>

        <section id="moles-to-molecules">
          <h2>Moles → Molecules</h2>
          <div class="field"><label>Moles</label><input id="mtm-moles" type="number" step="any" placeholder="e.g. 0.01"></div>
          <div class="field"><label>Significant figs</label><input id="mtm-sig" type="number" min="1" max="12" value="3"></div>
          <button class="btn" id="mtm-calc">Calculate</button>
          <div class="result" id="mtm-result">Result: —</div>
        </section>

        <section id="molecules-to-moles">
          <h2>Molecules → Moles</h2>
          <div class="field"><label>Molecules</label><input id="mtmoles-molecules" type="number" step="any" placeholder="e.g. 6.022e20"></div>
          <div class="field"><label>Significant figs</label><input id="mtmoles-sig" type="number" min="1" max="12" value="3"></div>
          <button class="btn" id="mtmoles-calc">Calculate</button>
          <div class="result" id="mtmoles-result">Result: —</div>
        </section>

        <section id="molecules-to-grams">
          <h2>Molecules → Grams</h2>
          <div class="field"><label>Compound/Element</label><input id="mtg2-formula" type="text" placeholder="e.g. H2O"></div>
          <div class="field"><label>Molecules</label><input id="mtg2-molecules" type="number" step="any" placeholder="e.g. 1.2044e24"></div>
          <div class="field"><label>Significant figs</label><input id="mtg2-sig" type="number" min="1" max="12" value="3"></div>
          <button class="btn" id="mtg2-calc">Calculate</button>
          <div class="result" id="mtg2-result">Result: —</div>
        </section>

        <section id="grams-to-molecules">
          <h2>Grams → Molecules</h2>
          <div class="field"><label>Compound/Element</label><input id="gtm2-formula" type="text" placeholder="e.g. NaCl"></div>
          <div class="field"><label>Grams</label><input id="gtm2-grams" type="number" step="any" placeholder="e.g. 58.5"></div>
          <div class="field"><label>Significant figs</label><input id="gtm2-sig" type="number" min="1" max="12" value="3"></div>
          <button class="btn" id="gtm2-calc">Calculate</button>
          <div class="result" id="gtm2-result">Result: —</div>
        </section>

        <section id="molar-mass">
          <h2>Molar Mass Calculator</h2>
          <div class="field"><label>Compound/Element</label><input id="mm-formula" type="text" placeholder="e.g. C6H12O6"></div>
          <button class="btn" id="mm-calc">Calculate</button>
          <div class="field"><label>Significant figs</label><input id="mm-sig" type="number" min="1" max="12" value="3"></div>
          <div class="result" id="mm-result">Molar Mass: —</div>
          <div class="note">Enter formulas with element symbols and integer counts. Parentheses supported, e.g. Ca(OH)2</div>
        </section>

        <section id="molar-mass-gm">
          <h2>Molar Mass (Grams & Molecules)</h2>
          <div class="field"><label>Grams</label><input id="mmgm-grams" type="number" step="any" placeholder="e.g. 18.0"></div>
          <div class="field"><label>Molecules</label><input id="mmgm-molecules" type="number" step="any" placeholder="e.g. 6.022e23"></div>
          <div class="field"><label>Significant figs</label><input id="mmgm-sig" type="number" min="1" max="12" value="3"></div>
          <button class="btn" id="mmgm-calc">Calculate</button>
          <div class="result" id="mmgm-result">Molar Mass: —</div>
        </section>

        <section id="words-to-molecules">
          <h2>Words to Molecules</h2>
          <div class="field"><label>Compound/Element</label><input id="wtm-formula" type="text" placeholder="e.g. Iron2 Sulfide"></div>
          <button class="btn" id="wtm-calc">Find Molecule</button>
          <div class="result" id="wtm-result">Compound:  —</div>
        </section>
      </div>
    </div>
    <footer>Avogadro's number used: 6.022×10^23 • Results formatted to three significant figures</footer>
  </div>

  <script>
  // Atomic masses (g/mol) — common elements; extend as needed
  const ATOMIC_MASSES = {
  H: 1.008, He: 4.0026, Li: 6.94, Be: 9.0122, B: 10.81, C: 12.011, N: 14.007, O: 15.999, F: 18.998, Ne: 20.180,
  Na: 22.990, Mg: 24.305, Al: 26.982, Si: 28.085, P: 30.974, S: 32.06, Cl: 35.45, Ar: 39.948, K: 39.098, Ca: 40.078,
  Sc: 44.956, Ti: 47.867, V: 50.942, Cr: 51.996, Mn: 54.938, Fe: 55.845, Co: 58.933, Ni: 58.693, Cu: 63.546, Zn: 65.38,
  Ga: 69.723, Ge: 72.63, As: 74.922, Se: 78.971, Br: 79.904, Kr: 83.798, Rb: 85.468, Sr: 87.62, Y: 88.906, Zr: 91.224,
  Nb: 92.906, Mo: 95.95, Tc: 98, Ru: 101.07, Rh: 102.91, Pd: 106.42, Ag: 107.87, Cd: 112.41, In: 114.82, Sn: 118.71,
  Sb: 121.76, Te: 127.60, I: 126.90, Xe: 131.29, Cs: 132.91, Ba: 137.33, La: 138.91, Ce: 140.12, Pr: 140.91, Nd: 144.24,
  Pm: 145, Sm: 150.36, Eu: 151.96, Gd: 157.25, Tb: 158.93, Dy: 162.50, Ho: 164.93, Er: 167.26, Tm: 168.93, Yb: 173.05,
  Lu: 174.97, Hf: 178.49, Ta: 180.95, W: 183.84, Re: 186.21, Os: 190.23, Ir: 192.22, Pt: 195.08, Au: 196.97, Hg: 200.59,
  Tl: 204.38, Pb: 207.2, Bi: 208.98, Po: 209, At: 210, Rn: 222, Fr: 223, Ra: 226, Ac: 227, Th: 232.04,
  Pa: 231.04, U: 238.03, Np: 237, Pu: 244, Am: 243, Cm: 247, Bk: 247, Cf: 251, Es: 252, Fm: 257,
  Md: 258, No: 259, Lr: 262, Rf: 267, Db: 270, Sg: 271, Bh: 270, Hs: 277, Mt: 276, Ds: 281,
  Rg: 280, Cn: 285, Nh: 284, Fl: 289, Mc: 288, Lv: 293, Ts: 294, Og: 294
};

const nameToCharge = {
    // --- Group 1: Alkali Metals (+1) ---
    "hydrogen": 1, "lithium": 1, "sodium": 1, "potassium": 1, "rubidium": 1, "cesium": 1, "francium": 1,
    
    // --- Group 2: Alkaline Earth Metals (+2) ---
    "beryllium": 2, "magnesium": 2, "calcium": 2, "strontium": 2, "barium": 2, "radium": 2,

    // --- Transition Metals (Standard & Variable) ---
    "scandium": 3, "yttrium": 3, "lutetium": 3, "lawrencium": 3,
    "titanium3": 3, "titanium4": 4, "zirconium": 4, "hafnium": 4, "rutherfordium": 4,
    "vanadium2": 2, "vanadium3": 3, "vanadium4": 4, "vanadium5": 5, "niobium": 5, "tantalum": 5, "dubnium": 5,
    "chromium2": 2, "chromium3": 3, "chromium6": 6, "molybdenum": 6, "tungsten6": 6, "seaborgium": 6,
    "manganese2": 2, "manganese3": 3, "manganese4": 4, "manganese7": 7, "technetium": 7, "rhenium": 7, "bohrium": 7,
    "iron2": 2, "iron3": 3, "ruthenium": 3, "osmium": 4, "hassium": 8,
    "cobalt2": 2, "cobalt3": 3, "rhodium": 3, "iridium": 4, "meitnerium": 9,
    "nickel2": 2, "nickel3": 3, "palladium2": 2, "palladium4": 4, "platinum2": 2, "platinum4": 4, "darmstadtium": 0,
    "copper1": 1, "copper2": 2, "silver": 1, "gold1": 1, "gold3": 3, "roentgenium": 0,
    "zinc": 2, "cadmium": 2, "mercury1": 1, "mercury2": 2, "copernicium": 2,

    // --- Post-Transition Metals & Metalloids ---
    "aluminum": 3, "gallium": 3, "indium": 3, "thallium1": 1, "thallium3": 3, "nihonium": 1,
    "germanium": 4, "tin2": 2, "tin4": 4, "lead2": 2, "lead4": 4, "flerovium": 2,
    "bismuth3": 3, "bismuth5": 5, "polonium": 2, "moscovium": 1, "livermorium": 2,

    // --- Lanthanides & Actinides ---
    "lanthanum": 3, "cerium3": 3, "cerium4": 4, "praseodymium": 3, "neodymium": 3, "promethium": 3, 
    "samarium": 3, "europium3": 3, "europium2": 2, "gadolinium": 3, "terbium": 3, "dysprosium": 3, 
    "holmium": 3, "erbium": 3, "thulium": 3, "ytterbium": 3, "actinium": 3, "thorium": 4, 
    "protactinium": 5, "uranium3": 3, "uranium4": 4, "uranium6": 6, "neptunium5": 5, "plutonium4": 4, 
    "americium3": 3, "curium": 3, "berkelium": 3, "californium": 3, "einsteinium": 3, "fermium": 3, 
    "mendelevium": 3, "nobelium": 2, "aluminium": 3,

    // --- Monatomic Anions (-ides) ---
    "hydride": -1, "boride": -3, "carbide": -4, "silicide": -4, "nitride": -3, "phosphide": -3, 
    "arsenide": -3, "antimonide": -3, "oxide": -2, "sulfide": -2, "selenide": -2, "telluride": -2, 
    "fluoride": -1, "chloride": -1, "bromide": -1, "iodide": -1, "astatide": -1, "tennesside": -1,

    // --- Polyatomic Ions (from your list) ---
    "nitrite": -1, "nitrate": -1, "acetate": -1, "hydroxide": -1, "cyanide": -1,
    "permanganate": -1, "hypochlorite": -1, "chlorite": -1, "chlorate": -1, "perchlorate": -1,
    "iodate": -1, "sulfite": -2, "sulfate": -2, "hydrogensulfate": -1, "bisulfate": -1,
    "carbonate": -2, "hydrogencarbonate": -1, "bicarbonate": -1, "dichromate": -2, "chromate": -2,
    "peroxide": -2, "oxalate": -2, "phosphite": -3, "phosphate": -3, "hydrogenphosphite": -2,
    "hydrogenphosphate": -2, "dihydrogenphosphite": -1, "dihydrogenphosphate": -1,
    "ammonium": 1, // Added from the partially visible top-left of your image

    // --- Noble Gases ---
    "helium": 0, "neon": 0, "argon": 0, "krypton": 0, "xenon": 0, "radon": 0, "oganesson": 0
};
const nameToSymbol = {
    // --- Group 1: Alkali Metals ---
    "hydrogen": "H", "lithium": "Li", "sodium": "Na", "potassium": "K", "rubidium": "Rb", "cesium": "Cs", "francium": "Fr",
    
    // --- Group 2: Alkaline Earth Metals ---
    "beryllium": "Be", "magnesium": "Mg", "calcium": "Ca", "strontium": "Sr", "barium": "Ba", "radium": "Ra",

    // --- Transition Metals ---
    "scandium": "Sc", "yttrium": "Y", "lutetium": "Lu", "lawrencium": "Lr",
    "titanium": "Ti", "titanium3": "Ti", "titanium4": "Ti", "zirconium": "Zr", "hafnium": "Hf", "rutherfordium": "Rf",
    "vanadium": "V", "vanadium2": "V", "vanadium3": "V", "vanadium4": "V", "vanadium5": "V", "niobium": "Nb", "tantalum": "Ta", "dubnium": "Db",
    "chromium": "Cr", "chromium2": "Cr", "chromium3": "Cr", "chromium6": "Cr", "molybdenum": "Mo", "tungsten": "W", "tungsten6": "W", "seaborgium": "Sg",
    "manganese": "Mn", "manganese2": "Mn", "manganese3": "Mn", "manganese4": "Mn", "manganese7": "Mn", "technetium": "Tc", "rhenium": "Re", "bohrium": "Bh",
    "iron": "Fe", "iron2": "Fe", "iron3": "Fe", "ruthenium": "Ru", "osmium": "Os", "hassium": "Hs",
    "cobalt": "Co", "cobalt2": "Co", "cobalt3": "Co", "rhodium": "Rh", "iridium": "Ir", "meitnerium": "Mt",
    "nickel": "Ni", "nickel2": "Ni", "nickel3": "Ni", "palladium": "Pd", "palladium2": "Pd", "palladium4": "Pd", "platinum": "Pt", "platinum2": "Pt", "platinum4": "Pt", "darmstadtium": "Ds",
    "copper": "Cu", "copper1": "Cu", "copper2": "Cu", "silver": "Ag", "gold": "Au", "gold1": "Au", "gold3": "Au", "roentgenium": "Rg",
    "zinc": "Zn", "cadmium": "Cd", "mercury": "Hg", "mercury1": "Hg", "mercury2": "Hg", "copernicium": "Cn",

    // --- Post-Transition Metals & Metalloids ---
    "boron": "B", "aluminum": "Al", "gallium": "Ga", "indium": "In", "thallium": "Tl", "thallium1": "Tl", "thallium3": "Tl", "nihonium": "Nh",
    "carbon": "C", "silicon": "Si", "germanium": "Ge", "tin": "Sn", "tin2": "Sn", "tin4": "Sn", "lead": "Pb", "lead2": "Pb", "lead4": "Pb", "flerovium": "Fl",
    "nitrogen": "N", "phosphorus": "P", "arsenic": "As", "antimony": "Sb", "bismuth": "Bi", "bismuth3": "Bi", "bismuth5": "Bi", "moscovium": "Mc",
    "oxygen": "O", "sulfur": "S", "selenium": "Se", "tellurium": "Te", "polonium": "Po", "livermorium": "Lv",
    "fluorine": "F", "chlorine": "Cl", "bromine": "Br", "iodine": "I", "astatine": "At", "tennessine": "Ts",

    // --- Lanthanides & Actinides ---
    "lanthanum": "La", "cerium": "Ce", "cerium3": "Ce", "cerium4": "Ce", "praseodymium": "Pr", "neodymium": "Nd", "promethium": "Pm", 
    "samarium": "Sm", "europium": "Eu", "europium3": "Eu", "europium2": "Eu", "gadolinium": "Gd", "terbium": "Tb", "dysprosium": "Dy", 
    "holmium": "Ho", "erbium": "Er", "thulium": "Tm", "ytterbium": "Yb", "actinium": "Ac", "thorium": "Th", 
    "protactinium": "Pa", "uranium": "U", "uranium3": "U", "uranium4": "U", "uranium6": "U", "neptunium": "Np", "neptunium5": "Np", "plutonium": "Pu", "plutonium4": "Pu", 
    "americium": "Am", "americium3": "Am", "curium": "Cm", "berkelium": "Bk", "californium": "Cf", "einsteinium": "Es", "fermium": "Fm", 
    "mendelevium": "Md", "nobelium": "No",

    // --- Anions (-ides) ---
    "hydride": "H", "boride": "B", "carbide": "C", "silicide": "Si", "nitride": "N", "phosphide": "P", 
    "arsenide": "As", "antimonide": "Sb", "oxide": "O", "sulfide": "S", "selenide": "Se", "telluride": "Te", 
    "fluoride": "F", "chloride": "Cl", "bromide": "Br", "iodide": "I", "astatide": "At", "tennesside": "Ts",

    // --- Polyatomic Ions (from your list) ---
    "nitrite": "NO2", "nitrate": "NO3", "acetate": "C2H3O2", "hydroxide": "OH", "cyanide": "CN",
    "permanganate": "MnO4", "hypochlorite": "ClO", "chlorite": "ClO2", "chlorate": "ClO3", "perchlorate": "ClO4",
    "iodate": "IO3", "sulfite": "SO3", "sulfate": "SO4", "hydrogensulfate": "HSO4", "bisulfate": "HSO4",
    "carbonate": "CO3", "hydrogencarbonate": "HCO3", "bicarbonate": "HCO3", "dichromate": "Cr2O7", "chromate": "CrO4",
    "peroxide": "O2", "oxalate": "C2O4", "phosphite": "PO3", "phosphate": "PO4", "hydrogenphosphite": "HPO3",
    "hydrogenphosphate": "HPO4", "dihydrogenphosphite": "H2PO3", "dihydrogenphosphate": "H2PO4",
    "ammonium": "NH4",

    // --- Noble Gases ---
    "helium": "He", "neon": "Ne", "argon": "Ar", "krypton": "Kr", "xenon": "Xe", "radon": "Rn", "oganesson": "Og"
};
  const AVOGADRO = 6.022e23;

  // Format number to a given number of significant figures (sig >=1)
  function toSigFigs(n, sig){
    sig = Math.max(1, parseInt(sig) || 3);
    if (!isFinite(n)) return String(n);
    if (n === 0) return (0).toFixed(Math.max(2, sig-1));
    const neg = n < 0;
    let abs = Math.abs(n);
    const exponent = Math.floor(Math.log10(abs));
    const factor = Math.pow(10, exponent - sig + 1);
    const rounded = Math.round(abs / factor) * factor;
    // Choose exponential for very large or very small numbers
    if (Math.abs(rounded) >= 10000 || Math.abs(rounded) < 0.001){
      const s = rounded.toExponential(sig-1);
      return neg ? '-' + s : s;
    }
    // Determine decimals to show
    const decimals = Math.max(0, sig - exponent - 1);
    const s = rounded.toFixed(decimals);
    return neg ? '-' + s : s;
  }

  // Parse chemical formula into element counts. Supports parentheses and numbers.
  function parseFormula(formula){
    if (!formula || typeof formula !== 'string') throw new Error('Invalid formula');
    // Tokenize: element symbols, numbers, parens
    const tokens = formula.match(/([A-Z][a-z]?|\(|\)|\d+|\.|·|\[|\])/g);
    if (!tokens) throw new Error('Invalid formula');
    const stack = [{}];
    for (let i=0;i<tokens.length;i++){
      const t = tokens[i];
      if (t === '(' || t === '['){ stack.push({}); continue; }
      if (t === ')' || t === ']'){
        const group = stack.pop();
        // look ahead for multiplier
        let mul = 1;
        if (i+1 < tokens.length && /^\d+$/.test(tokens[i+1])){ mul = parseInt(tokens[i+1],10); i++; }
        const top = stack[stack.length-1];
        for (const el in group) top[el] = (top[el]||0) + group[el]*mul;
        continue;
      }
      if (/^[A-Z][a-z]?$/.test(t)){
        let el = t;
        let count = 1;
        if (i+1 < tokens.length && /^\d+$/.test(tokens[i+1])){ count = parseInt(tokens[i+1],10); i++; }
        const top = stack[stack.length-1];
        top[el] = (top[el]||0) + count;
        continue;
      }
      // ignore dots or middot used in hydrates
      if (t === '.' || t === '·'){
        // treat hydrate separator by continuing — e.g. CuSO4·5H2O
        continue;
      }
      if (/^\d+$/.test(t)){
        // stray multiplier (e.g., leading) — multiply whole formula
        const multiplier = parseInt(t,10);
        const base = stack.pop();
        const target = stack[stack.length-1] || {};
        for (const el in base) target[el] = (target[el]||0) + base[el]*multiplier;
        stack.push(target);
        continue;
      }
      throw new Error('Invalid token in formula: ' + t);
    }
    if (stack.length !== 1) throw new Error('Unmatched parentheses in formula');
    return stack[0];
  }

  function atomicMass(formula){
    // Accept single element or full formula
    const counts = parseFormula(formula.trim());
    let mass = 0;
    for (const el in counts){
      const m = ATOMIC_MASSES[el];
      if (m == null) throw new Error('Unknown element: ' + el);
      mass += m * counts[el];
    }
    return mass;
  }
  function romanNumeralsToInt(roman) {
    const romanNumerals = {
      'I': 1,
      'V': 5,
      'X': 10,
      'L': 50,
      'C': 100,
      'D': 500,
      'M': 1000
    };
    let total = 0;
    let prevValue = 0;

    for (let i = roman.length - 1; i >= 0; i--) {
      const currentValue = romanNumerals[roman[i]];
      if (currentValue < prevValue) {
        total -= currentValue;
      } else {
        total += currentValue;
      }
      prevValue = currentValue;
    }
    return total;
  }
  function getGCF(a, b) {
  if (b === 0) {
    return Math.abs(a); // Return absolute value of a if b is 0
  } else {
    return getGCF(b, a % b); // Recursively call the function with b and the remainder
  }
}

  function isRoman(s) {
    return /^[IVXLCDM]+$/i.test(s);
  }

  // UI helpers
  function setResult(id, text, isError){
    const el = document.getElementById(id);
    el.textContent = 'Result: ' + text;
    el.style.color = isError ? '#900' : '';
  }

  // Wire menu
  document.querySelectorAll('.menu button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.panel;
      document.querySelectorAll('.panel section').forEach(sec=>sec.classList.remove('active'));
      document.getElementById(target).classList.add('active');
    });
  });

  // Calculations
  document.getElementById('mtg-calc').addEventListener('click', ()=>{
    try{
      const f = document.getElementById('mtg-formula').value || '';
      const moles = parseFloat(document.getElementById('mtg-moles').value);
      if (isNaN(moles)) throw new Error('Enter a valid number of moles');
      const mm = atomicMass(f);
      const grams = moles * mm;
      const sig = document.getElementById('mtg-sig').value || 3;
      setResult('mtg-result', toSigFigs(grams, sig) + ' grams');
    }catch(e){ setResult('mtg-result', e.message, true); }
  });

  document.getElementById('gtm-calc').addEventListener('click', ()=>{
    try{
      const f = document.getElementById('gtm-formula').value || '';
      const grams = parseFloat(document.getElementById('gtm-grams').value);
      if (isNaN(grams)) throw new Error('Enter a valid mass in grams');
      const mm = atomicMass(f);
      const moles = grams / mm;
      const sig = document.getElementById('gtm-sig').value || 3;
      setResult('gtm-result', toSigFigs(moles, sig) + ' moles');
    }catch(e){ setResult('gtm-result', e.message, true); }
  });

  document.getElementById('mtm-calc').addEventListener('click', ()=>{
    try{
      const moles = parseFloat(document.getElementById('mtm-moles').value);
      if (isNaN(moles)) throw new Error('Enter a valid number of moles');
      const molecules = moles * AVOGADRO;
      const sig = document.getElementById('mtm-sig').value || 3;
      setResult('mtm-result', toSigFigs(molecules, sig) + ' molecules');
    }catch(e){ setResult('mtm-result', e.message, true); }
  });

  document.getElementById('mtmoles-calc').addEventListener('click', ()=>{
    try{
      const molecules = parseFloat(document.getElementById('mtmoles-molecules').value);
      if (isNaN(molecules)) throw new Error('Enter a valid number of molecules');
      const moles = molecules / AVOGADRO;
      const sig = document.getElementById('mtmoles-sig').value || 3;
      setResult('mtmoles-result', toSigFigs(moles, sig) + ' moles');
    }catch(e){ setResult('mtmoles-result', e.message, true); }
  });

  document.getElementById('mtg2-calc').addEventListener('click', ()=>{
    try{
      const f = document.getElementById('mtg2-formula').value || '';
      const molecules = parseFloat(document.getElementById('mtg2-molecules').value);
      if (isNaN(molecules)) throw new Error('Enter a valid number of molecules');
      const moles = molecules / AVOGADRO;
      const mm = atomicMass(f);
      const grams = moles * mm;
      const sig = document.getElementById('mtg2-sig').value || 3;
      setResult('mtg2-result', toSigFigs(grams, sig) + ' grams');
    }catch(e){ setResult('mtg2-result', e.message, true); }
  });

  document.getElementById('gtm2-calc').addEventListener('click', ()=>{
    try{
      const f = document.getElementById('gtm2-formula').value || '';
      const grams = parseFloat(document.getElementById('gtm2-grams').value);
      if (isNaN(grams)) throw new Error('Enter a valid mass in grams');
      const mm = atomicMass(f);
      const moles = grams / mm;
      const molecules = moles * AVOGADRO;
      const sig = document.getElementById('gtm2-sig').value || 3;
      setResult('gtm2-result', toSigFigs(molecules, sig) + ' molecules');
    }catch(e){ setResult('gtm2-result', e.message, true); }
  });

  document.getElementById('mm-calc').addEventListener('click', ()=>{
    try{
      const f = document.getElementById('mm-formula').value || '';
      const mm = atomicMass(f);
      const sig = document.getElementById('mm-sig').value || 3;
      setResult('mm-result', toSigFigs(mm, sig) + ' g/mol');
    }catch(e){ setResult('mm-result', e.message, true); }
  });

  document.getElementById('mmgm-calc').addEventListener('click', ()=>{
    try{
      const grams = parseFloat(document.getElementById('mmgm-grams').value);
      const molecules = parseFloat(document.getElementById('mmgm-molecules').value);
      if (isNaN(grams)) throw new Error('Enter a valid mass in grams');
      if (isNaN(molecules)) throw new Error('Enter a valid number of molecules');
      const mm = (grams * AVOGADRO) / molecules;
      const sig = document.getElementById('mmgm-sig').value || 3;
      setResult('mmgm-result', toSigFigs(mm, sig) + ' g/mol');
    }catch(e){ setResult('mmgm-result', e.message, true); }
  });

document.getElementById('wtm-calc').addEventListener('click', () => {
  try {
    const input = document.getElementById('wtm-formula').value.trim().toLowerCase();
    // Remove parentheses and split by space
    let parts = input.replace(/\(|\)/g, "").split(/\s+/).filter(p => p); // filter empty
    
    // Process Roman Numerals: combine with previous if roman
    let processedParts = [];
    for (let i = 0; i < parts.length; i++) {
      if (i < parts.length - 1 && isRoman(parts[i+1])) {
        processedParts.push(parts[i] + romanNumeralsToInt(parts[i+1]));
        i++; // skip next
      } else {
        processedParts.push(parts[i]);
      }
    }
    if (processedParts.length !== 2) throw new Error('Enter exactly two parts: cation and anion');
    
    // Get charges
    let charge_pos = nameToCharge[processedParts[0]];
    let charge_neg = nameToCharge[processedParts[1]];
    if (!charge_pos || charge_pos <= 0) throw new Error('Invalid cation: ' + processedParts[0]);
    if (!charge_neg || charge_neg >= 0) throw new Error('Invalid anion: ' + processedParts[1]);
    
    // Criss-Cross Method
    const common = getGCF(Math.abs(charge_pos), Math.abs(charge_neg));
    const sub_pos = Math.abs(charge_neg) / common;
    const sub_neg = Math.abs(charge_pos) / common;
    
    // Build Formula
    const sym_pos = nameToSymbol[processedParts[0]];
    const sym_neg = nameToSymbol[processedParts[1]];
    if (!sym_pos || !sym_neg) throw new Error('Unknown element symbols');
    
    const formatPoly = (sym, sub) => {
        const isPoly = sym.length > 2 || /[0-9]/.test(sym);
        return (isPoly && sub > 1) ? `(${sym})${sub}` : `${sym}${sub > 1 ? sub : ""}`;
    };
    let result = formatPoly(sym_pos, sub_pos) + formatPoly(sym_neg, sub_neg);
    setResult('wtm-result', 'Compound: ' + result);
  } catch (e) { 
    setResult('wtm-result', e.message, true); 
  }
});

  // Enter key support for all inputs
  const inputToCalc = {
    'mtg-formula': 'mtg-calc', 'mtg-moles': 'mtg-calc', 'mtg-sig': 'mtg-calc',
    'gtm-formula': 'gtm-calc', 'gtm-grams': 'gtm-calc', 'gtm-sig': 'gtm-calc',
    'mtm-moles': 'mtm-calc', 'mtm-sig': 'mtm-calc',
    'mtmoles-molecules': 'mtmoles-calc', 'mtmoles-sig': 'mtmoles-calc',
    'wtm-formula': 'wtm-calc', 'wtm-sig': 'wtm-calc',
    'mtg2-formula': 'mtg2-calc', 'mtg2-molecules': 'mtg2-calc', 'mtg2-sig': 'mtg2-calc',
    'gtm2-formula': 'gtm2-calc', 'gtm2-grams': 'gtm2-calc', 'gtm2-sig': 'gtm2-calc',
    'mm-formula': 'mm-calc', 'mm-sig': 'mm-calc',
    'mmgm-grams': 'mmgm-calc', 'mmgm-molecules': 'mmgm-calc', 'mmgm-sig': 'mmgm-calc'
  };
  Object.keys(inputToCalc).forEach(inputId => {
    const inputEl = document.getElementById(inputId);
    if (inputEl) {
      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById(inputToCalc[inputId]).click();
        }
      });
    }
  });
  </script>
</body>
</html>
